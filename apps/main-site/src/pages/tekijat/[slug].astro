---
import { getCreatorBySlug } from '@roolipeli/database';
import Error404Content from '../../components/Error404Content.astro';
import ReferenceList from '../../components/ReferenceList.svelte';
import JsonLd from '../../components/seo/JsonLd.astro';
import { useTranslations } from '../../i18n/utils';
import Layout from '../../layouts/Layout.astro';
import '@roolipeli/design-system/components/card.css';
import '@roolipeli/design-system/components/tag.css';
import Breadcrumbs from '@roolipeli/design-system/components/Breadcrumbs.astro';
import '@roolipeli/design-system/components/breadcrumbs.css';

import { logDebug } from '@roolipeli/logger';
import { createSupabaseServerClient } from '../../lib/supabase';

const { slug } = Astro.params;

let creator;
if (slug) {
  try {
    const supabase = createSupabaseServerClient(Astro);
    creator = await getCreatorBySlug(supabase, slug);
  } catch (e) {
    logDebug(`Error fetching creator ${slug}:`, e instanceof Error ? e.message : String(e));
  }
}

if (!creator) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
}

const t = useTranslations((Astro.currentLocale as 'fi' | 'sv' | 'en') || 'fi');
const title = creator ? `${creator.name} | Roolipeli.info` : t('error.404.title');

// Flatten product references from junctions
const projects = creator
  ? creator?.products_creators?.map((pc) => ({
      ...pc.product,
      role: pc.role,
    })) || []
  : [];

const breadcrumbs = [
  { label: t('breadcrumb.home'), href: '/' },
  { label: t('nav.creators.label'), href: '/tekijat' },
  ...(creator ? [{ label: creator.name }] : []),
];

// JSON-LD schema with sameAs from references
const siteUrl = Astro.url.origin;
const jsonLd = creator
  ? (() => {
      const schema: Record<string, unknown> = {
        '@context': 'https://schema.org',
        '@type': 'Person',
        name: creator.name,
        url: `${siteUrl}/tekijat/${creator.slug}`,
      };
      const sameAs = (creator.references || [])
        .filter(
          (ref: { reference_type: string }) =>
            ref.reference_type === 'official' || ref.reference_type === 'source',
        )
        .map((ref: { url: string }) => ref.url);
      if (sameAs.length > 0) {
        schema.sameAs = sameAs;
      }
      return schema;
    })()
  : null;
---

<Layout title={title} lang={Astro.currentLocale as "fi" | "en" | "sv"}>
    <>
        {
            creator ? (
                <>
                    <Breadcrumbs items={breadcrumbs} />

                    <h1>{creator.name}</h1>

                    <div class="creator-layout breakout">
                        <section class="projects">
                            <span
                                class="label"
                                style="margin-bottom: var(--kide-space-4); display: block;"
                            >
                                {t("creator.projects.label")}
                            </span>
                            <div class="project-grid">
                                {projects.length > 0 ? (
                                    projects.map((product) => (
                                        <a
                                            href={`/tuotteet/${product.slug}`}
                                            class="card product-link"
                                        >
                                            <span class="label">
                                                {product.role}
                                            </span>
                                            <h3>{product.title}</h3>
                                            <div class="meta">
                                                <span class="tag">
                                                    {t(
                                                        `productType.${product.product_type}`,
                                                    )}
                                                </span>
                                                {product.year && (
                                                    <span class="tag">
                                                        {product.year}
                                                    </span>
                                                )}
                                                <span class="tag">
                                                    {t(`lang.${product.lang}`)}
                                                </span>
                                            </div>
                                        </a>
                                    ))
                                ) : (
                                    <p class="empty-state">
                                        {t("creator.projects.empty")}
                                    </p>
                                )}
                            </div>
                        </section>
                        {creator.references && creator.references.length > 0 && (
                            <section class="references card">
                                <span class="label">{t('creator.references.label')}</span>
                                <ReferenceList references={creator.references} />
                            </section>
                        )}
                    </div>
                    <JsonLd schema={jsonLd} />
                </>
            ) : (
                <Error404Content />
            )
        }
    </>
</Layout>

<style>
    .creator-layout {
        display: grid;
        gap: var(--kide-space-6);
    }

    .project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--kide-space-4);
    }

    .product-link {
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
    }

    .product-link h3 {
        margin: 0 0 var(--kide-space-1) 0;
        font-size: 1.125rem;
    }

    .meta {
        margin-top: auto;
        display: flex;
        gap: var(--kide-space-2);
    }

    .empty-state {
        color: var(--kide-ink-muted);
        font-style: italic;
    }
</style>
