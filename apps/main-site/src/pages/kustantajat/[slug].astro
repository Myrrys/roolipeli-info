---
import { getPublisherBySlug } from '@roolipeli/database';
import Error404Content from '../../components/Error404Content.astro';
import ReferenceList from '../../components/ReferenceList.svelte';
import JsonLd from '../../components/seo/JsonLd.astro';
import { useTranslations } from '../../i18n/utils';
import Layout from '../../layouts/Layout.astro';
import '@roolipeli/design-system/components/card.css';
import '@roolipeli/design-system/components/tag.css';
import Breadcrumbs from '@roolipeli/design-system/components/Breadcrumbs.astro';
import '@roolipeli/design-system/components/breadcrumbs.css';

import { logDebug } from '@roolipeli/logger';
import { createSupabaseServerClient } from '../../lib/supabase';

const { slug } = Astro.params;

let publisher;
if (slug) {
  try {
    const supabase = createSupabaseServerClient(Astro);
    publisher = await getPublisherBySlug(supabase, slug);
  } catch (e) {
    logDebug(`Error fetching publisher ${slug}:`, e instanceof Error ? e.message : String(e));
  }
}

if (!publisher) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
}

const t = useTranslations((Astro.currentLocale as 'fi' | 'sv' | 'en') || 'fi');
const title = publisher ? `${publisher.name} | Roolipeli.info` : t('error.404.title');

const breadcrumbs = [
  { label: t('breadcrumb.home'), href: '/' },
  { label: t('nav.publishers.label'), href: '/kustantajat' },
  ...(publisher ? [{ label: publisher.name }] : []),
];

// JSON-LD schema with sameAs from references
const siteUrl = Astro.url.origin;
const jsonLd = publisher
  ? (() => {
      const schema: Record<string, unknown> = {
        '@context': 'https://schema.org',
        '@type': 'Organization',
        name: publisher.name,
        url: `${siteUrl}/kustantajat/${publisher.slug}`,
      };
      if (publisher.description) {
        schema.description = publisher.description;
      }
      const sameAs = (publisher.references || [])
        .filter(
          (ref: { reference_type: string }) =>
            ref.reference_type === 'official' || ref.reference_type === 'source',
        )
        .map((ref: { url: string }) => ref.url);
      if (sameAs.length > 0) {
        schema.sameAs = sameAs;
      }
      return schema;
    })()
  : null;
---

<Layout title={title} lang={Astro.currentLocale as "fi" | "en" | "sv"}>
    <>
        {
            publisher ? (
                <>
                    <Breadcrumbs items={breadcrumbs} />

                    <h1>{publisher.name}</h1>

                    <div class="publisher-layout breakout">
                        {publisher.description && (
                            <section class="description card">
                                <span class="label">
                                    {t("publisher.description.label")}
                                </span>
                                <p>{publisher.description}</p>
                            </section>
                        )}

                        <section class="products">
                            <span
                                class="label"
                                style="margin-bottom: var(--kide-space-4); display: block;"
                            >
                                {t("publisher.products.label")}
                            </span>
                            <div class="product-grid">
                                {publisher.products &&
                                publisher.products.length > 0 ? (
                                    publisher.products.map((product) => (
                                        <a
                                            href={`/tuotteet/${product.slug}`}
                                            class="card product-link"
                                        >
                                            <span class="label">
                                                {t(
                                                    `productType.${product.product_type}`,
                                                )}
                                            </span>
                                            <h3>{product.title}</h3>
                                            <div class="meta">
                                                {product.year && (
                                                    <span class="tag">
                                                        {product.year}
                                                    </span>
                                                )}
                                                <span class="tag">
                                                    {t(`lang.${product.lang}`)}
                                                </span>
                                            </div>
                                        </a>
                                    ))
                                ) : (
                                    <p class="empty-state">
                                        {t("publisher.products.empty")}
                                    </p>
                                )}
                            </div>
                        </section>
                        {publisher.references && publisher.references.length > 0 && (
                            <section class="references card">
                                <span class="label">{t('publisher.references.label')}</span>
                                <ReferenceList references={publisher.references} />
                            </section>
                        )}
                    </div>
                    <JsonLd schema={jsonLd} />
                </>
            ) : (
                <Error404Content />
            )
        }
    </>
</Layout>

<style>
    .publisher-layout {
        display: grid;
        gap: var(--kide-space-6);
    }

    .description p {
        margin: 0;
        line-height: 1.6;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--kide-space-4);
    }

    .product-link {
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
    }

    .product-link h3 {
        margin: 0 0 var(--kide-space-1) 0;
        font-size: 1.125rem;
    }

    .meta {
        margin-top: auto;
        display: flex;
        gap: var(--kide-space-2);
    }

    .empty-state {
        color: var(--kide-ink-muted);
        font-style: italic;
    }
</style>
