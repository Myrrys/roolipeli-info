---
import { getPublisherBySlug } from '@roolipeli/database';
import Error404Content from '../../components/Error404Content.astro';
import { useTranslations } from '../../i18n/utils';
import Layout from '../../layouts/Layout.astro';
import '@roolipeli/design-system/components/card.css';
import '@roolipeli/design-system/components/tag.css';

const { slug } = Astro.params;

let publisher;
if (slug) {
  try {
    publisher = await getPublisherBySlug(slug);
  } catch (e) {
    if (import.meta.env.DEV) {
      console.error(`Error fetching publisher ${slug}:`, e);
    }
  }
}

if (!publisher) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
}

const t = useTranslations((Astro.currentLocale as 'fi' | 'sv' | 'en') || 'fi');
const title = publisher ? `${publisher.name} | Roolipeli.info` : t('error.404.title');
---

<Layout title={title} lang={Astro.currentLocale}>
    <main style="display: contents;">
        {
            publisher ? (
                <>
                    <div class="back-nav">
                        <a href="/kustantajat">‚Üê {t("publishers.backLink")}</a>
                    </div>

                    <h1>{publisher.name}</h1>

                    <div class="publisher-layout breakout">
                        {publisher.description && (
                            <section class="description card">
                                <span class="label">
                                    {t("publisher.description.label")}
                                </span>
                                <p>{publisher.description}</p>
                            </section>
                        )}

                        <section class="products">
                            <span
                                class="label"
                                style="margin-bottom: var(--kide-space-4); display: block;"
                            >
                                {t("publisher.products.label")}
                            </span>
                            <div class="product-grid">
                                {publisher.products &&
                                publisher.products.length > 0 ? (
                                    publisher.products.map((product) => (
                                        <a
                                            href={`/tuotteet/${product.slug}`}
                                            class="card product-link"
                                        >
                                            <span class="label">
                                                {t(
                                                    `productType.${product.product_type}`,
                                                )}
                                            </span>
                                            <h3>{product.title}</h3>
                                            <div class="meta">
                                                {product.year && (
                                                    <span class="tag">
                                                        {product.year}
                                                    </span>
                                                )}
                                                <span class="tag">
                                                    {t(`lang.${product.lang}`)}
                                                </span>
                                            </div>
                                        </a>
                                    ))
                                ) : (
                                    <p class="empty-state">
                                        {t("publisher.products.empty")}
                                    </p>
                                )}
                            </div>
                        </section>
                    </div>
                </>
            ) : (
                <Error404Content />
            )
        }
    </main>
</Layout>

<style>
    .back-nav {
        margin-bottom: var(--kide-space-4);
    }

    .back-nav a {
        color: var(--kide-ink-muted);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .back-nav a:hover {
        color: var(--kide-ice-deep);
    }

    .publisher-layout {
        display: grid;
        gap: var(--kide-space-6);
    }

    .description p {
        margin: 0;
        line-height: 1.6;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--kide-space-4);
    }

    .product-link {
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
    }

    .product-link h3 {
        margin: 0 0 var(--kide-space-1) 0;
        font-size: 1.125rem;
    }

    .meta {
        margin-top: auto;
        display: flex;
        gap: var(--kide-space-2);
    }

    .empty-state {
        color: var(--kide-ink-muted);
        font-style: italic;
    }
</style>
