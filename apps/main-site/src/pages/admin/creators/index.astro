---
import { logError } from '@roolipeli/logger';
import DataTable from '../../../components/admin/DataTable.astro';
import DeleteConfirm from '../../../components/admin/DeleteConfirm.svelte';
import { defaultLang, ui } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { handleAdminFlash } from '../../../lib/admin-flash';
import { addSessionSnack } from '../../../lib/snackbar';
import { createSupabaseServerClient } from '../../../lib/supabase';

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.creators');

handleAdminFlash(Astro.url, Astro.cookies, t);

const supabase = createSupabaseServerClient(Astro);

const { data: creators, error } = await supabase.from('creators').select('*').order('name');

if (error) {
  logError('Error fetching creators:', error.message);
  addSessionSnack(Astro.cookies, { type: 'error', message: t('admin.table.fetchError') });
}

const columns = [
  { key: 'name', header: t('admin.creators.col.name') },
  { key: 'slug', header: t('admin.creators.col.slug') },
];

const displayData = creators || [];
---

<AdminLayout title={title}>
  <div class="breakout">
    <div class="admin-page-header">
      <h1>{title}</h1>
      <a href="/admin/creators/new" class="btn btn-filled">
        <span class="kide-icon kide-icon--sm" aria-hidden="true">add</span>
        {t('admin.creators.new')}
      </a>
    </div>

    <DataTable
      columns={columns}
      data={displayData}
      editUrl={(id) => `/admin/creators/${id}/edit`}
      actionsLabel={t('admin.table.actions')}
      editLabel={t('admin.table.edit')}
      deleteLabel={t('admin.table.delete')}
      emptyText={t('admin.table.empty')}
      itemCountText={displayData.length > 0 ? `${displayData.length} ${t('admin.creators')}` : undefined}
    />
  </div>

  <DeleteConfirm
    client:only="svelte"
    endpoint="/api/admin/creators"
    redirectTo="/admin/creators"
    confirmTitle={t('admin.table.deleteConfirmTitle')}
    confirmMessage={t('admin.table.deleteConfirmMessage')}
    cancelLabel={t('admin.table.cancel')}
    deleteLabel={t('admin.table.delete')}
    deletingLabel={t('admin.table.deleting')}
  />
</AdminLayout>
