---
import { logError } from '@roolipeli/logger';
import DataTable from '../../../components/admin/DataTable.astro';
import DeleteConfirm from '../../../components/admin/DeleteConfirm.svelte';
import { defaultLang, ui } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { handleAdminFlash } from '../../../lib/admin-flash';
import { addSessionSnack } from '../../../lib/snackbar';
import { createSupabaseServerClient } from '../../../lib/supabase';

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.labels');

handleAdminFlash(Astro.url, Astro.cookies, t);

const supabase = createSupabaseServerClient(Astro);

const { data: labels, error } = await supabase.from('semantic_labels').select('*').order('label');

if (error) {
  logError('Error fetching labels:', error.message);
  addSessionSnack(Astro.cookies, { type: 'error', message: t('admin.table.fetchError') });
}

const columns = [
  { key: 'label', header: t('admin.labels.col.label') },
  { key: 'wikidata_id', header: t('admin.labels.col.wikidataId') },
];

const displayData =
  labels?.map((l) => ({
    id: l.id,
    label: l.label,
    wikidata_id: l.wikidata_id || '-',
  })) ?? [];
---

<AdminLayout title={title}>
  <div class="breakout">
    <div class="admin-page-header">
      <h1>{title}</h1>
      <a href="/admin/labels/new" class="btn btn-filled">
        <span class="kide-icon kide-icon--sm" aria-hidden="true">add</span>
        {t('admin.labels.new')}
      </a>
    </div>

    <DataTable
      columns={columns}
      data={displayData}
      editUrl={(id) => `/admin/labels/${id}/edit`}
      actionsLabel={t('admin.table.actions')}
      editLabel={t('admin.table.edit')}
      deleteLabel={t('admin.table.delete')}
      emptyText={t('admin.table.empty')}
      itemCountText={displayData.length > 0 ? `${displayData.length} ${t('admin.labels')}` : undefined}
    />
  </div>

  <DeleteConfirm
    client:only="svelte"
    endpoint="/api/admin/labels"
    redirectTo="/admin/labels"
    confirmTitle={t('admin.table.deleteConfirmTitle')}
    confirmMessage={t('admin.table.deleteConfirmMessage')}
    cancelLabel={t('admin.table.cancel')}
    deleteLabel={t('admin.table.delete')}
    deletingLabel={t('admin.table.deleting')}
  />
</AdminLayout>
