---
import { logError } from '@roolipeli/logger';
import DataTable from '../../../components/admin/DataTable.astro';
import DeleteConfirm from '../../../components/admin/DeleteConfirm.svelte';
import { defaultLang, ui } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { createSupabaseServerClient } from '../../../lib/supabase';

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.publishers');

const supabase = createSupabaseServerClient(Astro);

const { data: publishers, error } = await supabase.from('publishers').select('*').order('name');

if (error) {
  logError('Error fetching publishers:', error.message);
}

const columns = [
  { key: 'name', header: t('admin.publishers.col.name') },
  { key: 'slug', header: t('admin.publishers.col.slug') },
];

const displayData = publishers || [];
---

<AdminLayout title={title}>
  <div class="breakout">
    <div class="admin-page-header">
      <h1>{title}</h1>
      <a href="/admin/publishers/new" class="btn btn-filled">
        <span class="kide-icon kide-icon--sm" aria-hidden="true">add</span>
        {t('admin.publishers.new')}
      </a>
    </div>

    {error && <div class="admin-error-banner">Failed to load publishers.</div>}

    <DataTable
      columns={columns}
      data={displayData}
      editUrl={(id) => `/admin/publishers/${id}/edit`}
      actionsLabel={t('admin.table.actions')}
      editLabel={t('admin.table.edit')}
      deleteLabel={t('admin.table.delete')}
      emptyText={t('admin.table.empty')}
      itemCountText={displayData.length > 0 ? `${displayData.length} ${t('admin.publishers')}` : undefined}
    />
  </div>

  <DeleteConfirm
    client:only="svelte"
    endpoint="/api/admin/publishers"
    redirectTo="/admin/publishers"
    confirmTitle={t('admin.table.deleteConfirmTitle')}
    confirmMessage={t('admin.table.deleteConfirmMessage')}
    cancelLabel={t('admin.table.cancel')}
    deleteLabel={t('admin.table.delete')}
    deletingLabel={t('admin.table.deleting')}
  />
</AdminLayout>
