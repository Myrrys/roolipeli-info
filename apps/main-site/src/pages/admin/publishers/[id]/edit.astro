---
import { logError } from '@roolipeli/logger';
import PublisherForm from '../../../../components/admin/PublisherForm.svelte';
import { defaultLang, ui } from '../../../../i18n/ui';
import { useTranslations } from '../../../../i18n/utils';
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { createSupabaseServerClient } from '../../../../lib/supabase';

const { id } = Astro.params;
const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.publishers.edit');

if (!id) return Astro.redirect('/admin/publishers');

const supabase = createSupabaseServerClient(Astro);

const { data: publisher, error } = await supabase
  .from('publishers')
  .select('*')
  .eq('id', id)
  .single();

if (error || !publisher) {
  logError('Error fetching publisher:', error?.message ?? 'Unknown error');
  return Astro.redirect('/admin/publishers?error=not_found');
}

// Fetch references from unified entity_references table
const { data: publisherReferences } = await supabase
  .from('entity_references')
  .select('*')
  .eq('entity_type', 'publisher')
  .eq('entity_id', id);

const transformedPublisher = {
  ...publisher,
  references: (publisherReferences || []).map((r) => ({
    reference_type: r.reference_type,
    label: r.label,
    url: r.url,
  })),
};
---

<AdminLayout title={title}>
    <div class="page-header">
        <h1>{title}: {publisher.name}</h1>
    </div>

    <PublisherForm
        publisher={transformedPublisher}
        submitUrl={`/api/admin/publishers/${id}`}
        method="PUT"
        client:load
    />
</AdminLayout>

<style>
  .page-header {
    margin-bottom: var(--kide-space-6);
  }

  h1 {
    font-family: var(--kide-font-serif);
    font-size: 2rem;
    color: var(--kide-ink-header);
  }
</style>
