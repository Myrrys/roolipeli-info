---
import { logError } from '@roolipeli/logger';
import DataTable from '../../../components/admin/DataTable.astro';
import DeleteConfirm from '../../../components/admin/DeleteConfirm.svelte';
import { defaultLang, ui } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { addSessionSnack } from '../../../lib/snackbar';
import { createSupabaseServerClient } from '../../../lib/supabase';

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.products');

const supabase = createSupabaseServerClient(Astro);

const { data: products, error } = await supabase
  .from('products')
  .select(
    `
      *,
      publisher:publishers(name)
    `,
  )
  .order('created_at', { ascending: false });

if (error) {
  logError('Error fetching products:', error.message);
  addSessionSnack(Astro.cookies, { type: 'error', message: t('admin.table.fetchError') });
}

const tableData =
  products?.map((p) => ({
    ...p,
    publisher_name: p.publisher?.name || '-',
  })) || [];

const columns = [
  { key: 'title', header: t('admin.products.col.title') },
  { key: 'publisher', header: t('admin.products.col.publisher') },
  { key: 'type', header: t('admin.products.col.type') },
  { key: 'year', header: t('admin.products.col.year') },
];

const displayData = tableData.map((p) => ({
  id: p.id,
  title: p.title,
  publisher: p.publisher_name,
  type: t(`productType.${p.product_type}` as any),
  year: p.year,
}));
---

<AdminLayout title={title}>
  <div class="breakout">
    <div class="admin-page-header">
      <h1>{title}</h1>
      <a href="/admin/products/new" class="btn btn-filled">
        <span class="kide-icon kide-icon--sm" aria-hidden="true">add</span>
        {t("admin.products.new")}
      </a>
    </div>

    <DataTable
      columns={columns}
      data={displayData}
      editUrl={(id) => `/admin/products/${id}/edit`}
      actionsLabel={t("admin.table.actions")}
      editLabel={t("admin.table.edit")}
      deleteLabel={t("admin.table.delete")}
      emptyText={t("admin.table.empty")}
      itemCountText={displayData.length > 0
        ? `${displayData.length} ${t("admin.products")}`
        : undefined}
    />
  </div>

  <DeleteConfirm
    client:only="svelte"
    endpoint="/api/admin/products"
    redirectTo="/admin/products"
    confirmTitle={t("admin.table.deleteConfirmTitle")}
    confirmMessage={t("admin.table.deleteConfirmMessage")}
    cancelLabel={t("admin.table.cancel")}
    deleteLabel={t("admin.table.delete")}
    deletingLabel={t("admin.table.deleting")}
  />
</AdminLayout>
