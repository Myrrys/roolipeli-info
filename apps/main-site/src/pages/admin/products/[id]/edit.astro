---
import { logError } from '@roolipeli/logger';
import ProductForm from '../../../../components/admin/ProductForm.svelte';
import { defaultLang, ui } from '../../../../i18n/ui';
import { useTranslations } from '../../../../i18n/utils';
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { createSupabaseServerClient } from '../../../../lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/products');
}

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.products.edit');

const supabase = createSupabaseServerClient(Astro);

// Fetch product with creators and labels
const { data: product, error } = await supabase
  .from('products')
  .select(
    `
        *,
        products_creators(
            role,
            creator_id
        ),
        product_semantic_labels(
            label_id
        ),
        product_isbns(*)
    `,
  )
  .eq('id', id)
  .single();

if (error || !product) {
  logError('Error fetching product:', error?.message ?? 'Unknown error');
  return Astro.redirect('/admin/products?error=not_found');
}

// Fetch references from unified entity_references table
const { data: productReferences } = await supabase
  .from('entity_references')
  .select('*')
  .eq('entity_type', 'product')
  .eq('entity_id', id);

// Fetch options
const { data: publishers } = await supabase.from('publishers').select('*').order('name');
const { data: creators } = await supabase.from('creators').select('*').order('name');
const { data: labels } = await supabase.from('semantic_labels').select('*').order('label');
const { data: games } = await supabase.from('games').select('id, name').order('name');

// Resolve cover URL server-side (ROO-86: no Supabase client in browser)
const coverUrl = product.cover_image_path
  ? supabase.storage.from('covers').getPublicUrl(product.cover_image_path).data.publicUrl
  : undefined;

// Transform product data to expected format
const transformedProduct = {
  ...product,
  creators: product.products_creators,
  labels: product.product_semantic_labels,
  references: productReferences || [],
  isbns: product.product_isbns,
};
---

<AdminLayout title={title}>
  <div class="page-header">
    <h1>{title}: {product.title}</h1>
  </div>
  <section>
    <ProductForm
      product={transformedProduct}
      publishers={publishers || []}
      creators={creators || []}
      labels={labels || []}
      games={games || []}
      submitUrl={`/api/admin/products/${id}`}
      method="PUT"
      coverUrl={coverUrl}
      client:load
    />
  </section>
</AdminLayout>
