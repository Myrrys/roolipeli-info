---
import ProductForm from '../../../../components/admin/ProductForm.astro';
import { defaultLang, ui } from '../../../../i18n/ui';
import { useTranslations } from '../../../../i18n/utils';
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { createSupabaseServerClient } from '../../../../lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/products');
}

const lang = (Astro.currentLocale as keyof typeof ui) || defaultLang;
const t = useTranslations(lang);
const title = t('admin.products.edit');

const supabase = createSupabaseServerClient(Astro);

// Fetch product with creators
const { data: product, error } = await supabase
  .from('products')
  .select(
    `
        *,
        products_creators(
            role,
            creator_id
        )
    `,
  )
  .eq('id', id)
  .single();

if (error || !product) {
  console.error('Error fetching product:', error);
  return Astro.redirect('/admin/products?error=not_found');
}

// Fetch options
const { data: publishers } = await supabase.from('publishers').select('*').order('name');
const { data: creators } = await supabase.from('creators').select('*').order('name');

// Transform product creators to expected format
const transformedProduct = {
  ...product,
  creators: product.products_creators,
};
---

<AdminLayout title={title}>
    <div class="page-header">
        <h1>{title}: {product.title}</h1>
    </div>

    <ProductForm
        product={transformedProduct}
        publishers={publishers || []}
        creators={creators || []}
        submitUrl={`/api/admin/products/${id}`}
        method="PUT"
    />
</AdminLayout>

<style>
    .page-header {
        margin-bottom: var(--kide-space-6);
    }
    h1 {
        font-family: var(--kide-font-serif);
        font-size: 2rem;
        color: var(--kide-ink-header);
    }
</style>
