---
import { getProductBySlug } from '@roolipeli/database';
import ReferenceList from '../../components/ReferenceList.svelte';
import { useTranslations } from '../../i18n/utils';
import Layout from '../../layouts/Layout.astro';
import '@roolipeli/design-system/components/card.css';
import '@roolipeli/design-system/components/tag.css';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

let product;
try {
  product = await getProductBySlug(slug);
} catch (e) {
  return Astro.redirect('/404');
}

if (!product) {
  return Astro.redirect('/404');
}

const t = useTranslations(Astro.currentLocale);
const title = `${product.title} | Roolipeli.info`;

const references = product.product_references || [];
// @ts-ignore - TODO: fix typing for reference_type once DB types propagate fully
const officialRefs = references.filter((r) => r.reference_type === 'official');
const otherRefs = references.filter((r) => r.reference_type !== 'official');
---

<Layout title={title} lang={Astro.currentLocale}>
    <main style="display: contents;">
        <div class="back-nav">
            <a href="/tuotteet">‚Üê {t("products.backLink")}</a>
        </div>

        <h1>{product.title}</h1>

        <div class="product-layout breakout">
            <section class="metadata card">
                <span class="label">{t("product.metadata.label")}</span>
                <dl>
                    <div>
                        <dt>{t("product.metadata.type")}</dt>
                        <dd><span class="tag">{product.product_type}</span></dd>
                    </div>
                    {
                        product.year && (
                            <div>
                                <dt>{t("product.metadata.year")}</dt>
                                <dd>{product.year}</dd>
                            </div>
                        )
                    }
                    <div>
                        <dt>{t("product.metadata.lang")}</dt>
                        <dd>
                            <span class="tag">{product.lang.toUpperCase()}</span
                            >
                        </dd>
                    </div>
                    {
                        product.publisher && (
                            <div>
                                <dt>{t("product.metadata.publisher")}</dt>
                                <dd>
                                    <a
                                        href={`/kustantajat/${product.publisher.slug}`}
                                    >
                                        {product.publisher.name}
                                    </a>
                                </dd>
                            </div>
                        )
                    }
                    {
                        product.isbn && (
                            <div>
                                <dt>{t("product.metadata.isbn")}</dt>
                                <dd>{product.isbn}</dd>
                            </div>
                        )
                    }
                    ) }
                    {
                        officialRefs.length > 0 && (
                            <div>
                                <dt>{t("product.official.label")}</dt>
                                <dd>
                                    <ReferenceList
                                        references={officialRefs}
                                        lang={Astro.currentLocale}
                                    />
                                </dd>
                            </div>
                        )
                    }
                </dl>
            </section>

            <section class="content">
                {
                    product.description && (
                        <div class="description card">
                            <span class="label">
                                {t("product.description.label")}
                            </span>
                            <p>{product.description}</p>
                        </div>
                    )
                }

                {
                    product.products_creators &&
                        product.products_creators.length > 0 && (
                            <div class="creators card">
                                <span class="label">
                                    {t("product.creators.label")}
                                </span>
                                <ul class="creator-list">
                                    {product.products_creators.map((pc) => (
                                        <li>
                                            <a
                                                href={`/tekijat/${pc.creator.slug}`}
                                            >
                                                {pc.creator.name}
                                            </a>
                                            <span class="role">{pc.role}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )
                }
            </section>

            {
                otherRefs.length > 0 && (
                    <section class="references card">
                        <span class="label">{t("product.reviews.label")}</span>
                        <ReferenceList
                            references={otherRefs}
                            lang={Astro.currentLocale}
                        />
                    </section>
                )
            }
        </div>
    </main>
</Layout>

<style>
    .back-nav {
        margin-bottom: var(--kide-space-4);
    }

    .back-nav a {
        color: var(--kide-ink-muted);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .back-nav a:hover {
        color: var(--kide-ice-deep);
    }

    .product-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: var(--kide-space-6);
        align-items: start;
    }

    @media (max-width: 768px) {
        .product-layout {
            grid-template-columns: 1fr;
        }
    }

    .metadata dl {
        margin: 0;
        display: grid;
        gap: var(--kide-space-3);
    }

    .metadata dt {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--kide-ink-muted);
        font-weight: 600;
    }

    .metadata dd {
        margin: 0;
        font-weight: 500;
    }

    .metadata a {
        color: var(--kide-ice-deep);
        text-decoration: none;
    }

    .content {
        display: grid;
        gap: var(--kide-space-4);
    }

    .description p {
        margin: 0;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .creator-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--kide-space-2);
    }

    .creator-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: var(--kide-space-1);
        border-bottom: 1px solid var(--kide-ice-light);
    }

    .creator-list li:last-child {
        border-bottom: none;
    }

    .creator-list a {
        color: var(--kide-ice-deep);
        text-decoration: none;
        font-weight: 500;
    }

    .role {
        font-size: 0.75rem;
        color: var(--kide-ink-muted);
        font-style: italic;
    }
</style>
