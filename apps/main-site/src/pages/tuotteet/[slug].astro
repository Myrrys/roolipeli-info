---
import { getProductBySlug, type ProductReference } from '@roolipeli/database';
import Error404Content from '../../components/Error404Content.astro';
import ReferenceList from '../../components/ReferenceList.svelte';
import { useTranslations } from '../../i18n/utils';
import Layout from '../../layouts/Layout.astro';
import '@roolipeli/design-system/components/card.css';
import '@roolipeli/design-system/components/tag.css';

const { slug } = Astro.params;

let product;
if (slug) {
  try {
    product = await getProductBySlug(slug);
  } catch (e) {
    if (import.meta.env.DEV) {
      console.error(`Error fetching product ${slug}:`, e);
    }
  }
}

if (!product) {
  Astro.response.status = 404;
  Astro.response.statusText = 'Not Found';
}

const t = useTranslations((Astro.currentLocale as 'fi' | 'sv' | 'en') || 'fi');
const title = product ? `${product.title} | Roolipeli.info` : t('error.404.title');

const references = product ? (product.product_references as ProductReference[]) || [] : [];
const officialRefs = references.filter((r) => r.reference_type === 'official');
const otherRefs = references.filter((r) => r.reference_type !== 'official');

// Sort labels by idx
const labels = product
  ? (product.product_semantic_labels || [])
      .sort((a, b) => (a.idx ?? 0) - (b.idx ?? 0))
      .map((psl) => psl.label)
      .filter(Boolean)
  : [];

// Generate JSON-LD with Wikidata links for semantic labels
const jsonLd = product
  ? {
      '@context': 'https://schema.org',
      '@type': 'Product',
      name: product.title,
      description: product.description || undefined,
      identifier: product.isbn || undefined,
      ...(labels.length > 0 && {
        keywords: labels.map((l) => ({
          '@type': 'DefinedTerm',
          name: l.label,
          ...(l.wikidata_id && {
            sameAs: `https://www.wikidata.org/wiki/${l.wikidata_id}`,
          }),
        })),
      }),
    }
  : null;
---

<Layout title={title} lang={Astro.currentLocale}>
    <main style="display: contents;">
        {
            product ? (
                <>
                    <div class="back-nav">
                        <a href="/tuotteet">{t("products.backLink")}</a>
                    </div>

                    <h1>{product.title}</h1>

                    <div class="product-layout breakout">
                        <section class="metadata card">
                            <span class="label">
                                {t("product.metadata.label")}
                            </span>
                            <dl>
                                <dt>{t("product.metadata.type")}</dt>
                                <dd>
                                    <span class="tag">
                                        {t(
                                            `productType.${product.product_type}`,
                                        )}
                                    </span>
                                </dd>

                                {product.year && (
                                    <>
                                        <dt>{t("product.metadata.year")}</dt>
                                        <dd>{product.year}</dd>
                                    </>
                                )}

                                <dt>{t("product.metadata.lang")}</dt>
                                <dd>
                                    <span class="tag">
                                        {t(`lang.${product.lang}`)}
                                    </span>
                                </dd>

                                {product.publisher && (
                                    <>
                                        <dt>
                                            {t("product.metadata.publisher")}
                                        </dt>
                                        <dd>
                                            <a
                                                href={`/kustantajat/${product.publisher.slug}`}
                                            >
                                                {product.publisher.name}
                                            </a>
                                        </dd>
                                    </>
                                )}

                                {product.isbn && (
                                    <>
                                        <dt>{t("product.metadata.isbn")}</dt>
                                        <dd>{product.isbn}</dd>
                                    </>
                                )}

                                {/* Display semantic labels */}
                                {labels.length > 0 && (
                                    <>
                                        <dt>{t("product.labels.label")}</dt>
                                        <dd class="labels-list">
                                            {labels.map((l) => (
                                                <span class="tag label-tag">
                                                    {l.wikidata_id ? (
                                                        <a
                                                            href={`https://www.wikidata.org/wiki/${l.wikidata_id}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                        >
                                                            {l.label}
                                                        </a>
                                                    ) : (
                                                        l.label
                                                    )}
                                                </span>
                                            ))}
                                        </dd>
                                    </>
                                )}

                                {officialRefs.length > 0 && (
                                    <>
                                        <dt>{t("product.official.label")}</dt>
                                        <dd>
                                            <ReferenceList
                                                references={officialRefs}
                                            />
                                        </dd>
                                    </>
                                )}
                            </dl>
                        </section>

                        <section class="content">
                            {product.description && (
                                <div class="description card">
                                    <span class="label">
                                        {t("product.description.label")}
                                    </span>
                                    <p>{product.description}</p>
                                </div>
                            )}

                            {product.products_creators &&
                                product.products_creators.length > 0 && (
                                    <div class="creators card">
                                        <span class="label">
                                            {t("product.creators.label")}
                                        </span>
                                        <ul class="creator-list">
                                            {product.products_creators.map(
                                                (pc) => (
                                                    <li>
                                                        <a
                                                            href={`/tekijat/${pc.creator.slug}`}
                                                        >
                                                            {pc.creator.name}
                                                        </a>
                                                        <span class="role">
                                                            {pc.role}
                                                        </span>
                                                    </li>
                                                ),
                                            )}
                                        </ul>
                                    </div>
                                )}
                        </section>

                        {otherRefs.length > 0 && (
                            <section class="references card">
                                <span class="label">
                                    {t("product.reviews.label")}
                                </span>
                                <ReferenceList references={otherRefs} />
                            </section>
                        )}
                    </div>
                    <script
                        type="application/ld+json"
                        set:html={JSON.stringify(jsonLd)}
                    />
                </>
            ) : (
                <Error404Content />
            )
        }
    </main>
</Layout>

<style>
    .back-nav {
        margin-bottom: var(--kide-space-4);
    }

    .back-nav a {
        color: var(--kide-ink-muted);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .back-nav a:hover {
        color: var(--kide-ice-deep);
    }

    .product-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: var(--kide-space-6);
        align-items: start;
    }

    @media (max-width: 768px) {
        .product-layout {
            grid-template-columns: 1fr;
        }
    }

    .metadata dl {
        margin: 0;
        display: grid;
        gap: var(--kide-space-3);
    }

    .metadata dt {
        font-size: 0.75rem; /* No token for this small size yet, keeping but noting debt. */
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--kide-ink-muted);
        font-weight: 600;
    }

    .metadata dd {
        margin: 0;
        font-weight: 500;
    }

    .metadata a {
        color: var(--kide-ice-deep);
        text-decoration: none;
    }

    .content {
        display: grid;
        gap: var(--kide-space-4);
    }

    .description p {
        margin: 0;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .creator-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--kide-space-2);
    }

    .creator-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: var(--kide-space-1);
        border-bottom: var(--kide-control-border-width) solid
            var(--kide-ice-light);
    }

    .creator-list li:last-child {
        border-bottom: none;
    }

    .creator-list a {
        color: var(--kide-ice-deep);
        text-decoration: none;
        font-weight: 500;
    }

    .role {
        font-size: 0.75rem; /* No token for this size yet */
        color: var(--kide-ink-muted);
        font-style: italic;
    }

    .labels-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--kide-space-1);
    }

    .label-tag a {
        color: inherit;
        text-decoration: none;
    }

    .label-tag a:hover {
        text-decoration: underline;
    }
</style>
