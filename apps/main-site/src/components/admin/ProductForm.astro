---
import {
  type Creator,
  type Product,
  ProductLangEnum,
  ProductTypeEnum,
  type Publisher,
} from '@roolipeli/database';
import FormField from './FormField.astro';

interface Props {
  product?: Product & { creators?: { creator_id: string; role: string }[] };
  publishers: Publisher[];
  creators: Creator[];
  submitUrl: string;
  method?: 'POST' | 'PUT';
}

const { product, publishers, creators, submitUrl, method = 'POST' } = Astro.props;

// Prepare initial state
const initialCreators = product?.creators || [];
const jsonInitialCreators = JSON.stringify(initialCreators);
const jsonAllCreators = JSON.stringify(creators);
---

<form
    id="product-form"
    class="admin-form"
    data-method={method}
    data-url={submitUrl}
    data-initial-creators={jsonInitialCreators}
    data-all-creators={jsonAllCreators}
>
    <div class="form-grid">
        <FormField label="Title" name="title" value={product?.title} required />
        <FormField
            label="Slug"
            name="slug"
            type="slug"
            value={product?.slug}
            required
        />
    </div>

    <div class="form-grid">
        <div class="form-group">
            <label for="publisher_id">Publisher</label>
            <select id="publisher_id" name="publisher_id">
                <option value="">-- None --</option>
                {
                    publishers.map((p) => (
                        <option
                            value={p.id}
                            selected={product?.publisher_id === p.id}
                        >
                            {p.name}
                        </option>
                    ))
                }
            </select>
        </div>

        <div class="form-group">
            <label for="product_type">Type</label>
            <select id="product_type" name="product_type">
                {
                    ProductTypeEnum.options.map((t) => (
                        <option
                            value={t}
                            selected={product?.product_type === t}
                        >
                            {t}
                        </option>
                    ))
                }
            </select>
        </div>
    </div>

    <div class="form-grid">
        <FormField
            label="Year"
            name="year"
            type="number"
            value={product?.year ?? ""}
        />
        <FormField label="ISBN" name="isbn" value={product?.isbn ?? ""} />
    </div>

    <div class="form-group">
        <label for="lang">Language</label>
        <select id="lang" name="lang">
            {
                ProductLangEnum.options.map((l) => (
                    <option value={l} selected={product?.lang === l}>
                        {l}
                    </option>
                ))
            }
        </select>
    </div>

    <FormField
        label="Description"
        name="description"
        type="textarea"
        value={product?.description ?? ""}
    />

    <!-- Creators Section -->
    <div class="creators-section">
        <h3>Creators</h3>
        <div id="creators-list">
            <!-- Rows injected by JS -->
        </div>
        <button type="button" id="add-creator-btn" class="btn-secondary"
            >+ Add Creator</button
        >
    </div>

    <div class="form-actions">
        <a href="/admin/products" class="btn-cancel">Cancel</a>
        <button type="submit" class="btn-save">Save Product</button>
    </div>
</form>

<script>
    import { setupAutoSlug } from "../../lib/slug.client";
    import type { Creator } from "@roolipeli/database";

    interface CreatorEntry {
        creator_id: string;
        role: string;
    }

    const form = document.getElementById("product-form") as HTMLFormElement;
    const container = document.getElementById("creators-list");
    const addBtn = document.getElementById("add-creator-btn");

    if (!form || !container || !addBtn) {
        console.error("ProductForm elements not found");
    }

    // Parse data from attributes
    let assignedCreators: CreatorEntry[] = [];
    let allCreators: Creator[] = [];
    try {
        if (form && form.dataset.initialCreators) {
            assignedCreators = JSON.parse(form.dataset.initialCreators);
        }
        if (form && form.dataset.allCreators) {
            allCreators = JSON.parse(form.dataset.allCreators);
        }
    } catch (e) {
        console.error("Failed to parse creators data", e);
    }

    function renderCreators() {
        if (!container) return;
        container.innerHTML = "";
        assignedCreators.forEach((entry, index) => {
            const row = document.createElement("div");
            row.className = "creator-row";

            // Creator Select
            const select = document.createElement("select");
            select.className = "creator-select";
            select.value = entry.creator_id;
            select.innerHTML = `<option value="">Select Creator...</option>`;

            allCreators.forEach((c) => {
                const opt = document.createElement("option");
                opt.value = c.id ?? "";
                opt.textContent = c.name;
                if (c.id === entry.creator_id) opt.selected = true;
                select.appendChild(opt);
            });

            select.onchange = (e) => {
                assignedCreators[index].creator_id = (
                    e.target as HTMLFormElement
                ).value;
            };

            // Role Input
            const roleInput = document.createElement("input");
            roleInput.type = "text";
            roleInput.placeholder = "Role (e.g. Author)";
            roleInput.value = entry.role;
            roleInput.className = "creator-role";
            roleInput.oninput = (e) => {
                assignedCreators[index].role = (
                    e.target as HTMLFormElement
                ).value;
            };

            // Remove Button
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.textContent = "Ã—";
            removeBtn.className = "btn-icon-remove";
            removeBtn.onclick = () => {
                assignedCreators.splice(index, 1);
                renderCreators();
            };

            row.appendChild(select);
            row.appendChild(roleInput);
            row.appendChild(removeBtn);
            container.appendChild(row);
        });
    }

    if (addBtn) {
        addBtn.addEventListener("click", () => {
            assignedCreators.push({ creator_id: "", role: "" });
            renderCreators();
        });
    }

    // Initial Render
    renderCreators();

    // Auto Slug
    setupAutoSlug('input[name="title"]', 'input[name="slug"]');

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Gather standard fields
            const formData = new FormData(form);
            const rawData = Object.fromEntries(formData.entries());

            // Process types
            const yearValue = rawData.year as string;
            const pubValue = rawData.publisher_id as string;
            const data = {
                ...rawData,
                year: yearValue ? parseInt(yearValue) : null,
                publisher_id: pubValue === "" ? null : pubValue,
            };

            // Add creators
            // Filter out empty ones
            const validCreators = assignedCreators.filter(
                (c) => c.creator_id && c.role,
            );

            const payload = {
                ...data,
                creators: validCreators,
            };

            const url = form.dataset.url;
            const method = form.dataset.method || "POST";

            if (!url) return;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (res.ok) {
                    window.location.href = "/admin/products?success=saved";
                } else {
                    const result = await res.json();
                    alert("Error: " + (result.error || "Unknown error"));
                }
            } catch (err) {
                console.error(err);
                alert("Network error");
            }
        });
    }
</script>

<style>
    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--kide-space-2);
        margin-bottom: var(--kide-space-4);
    }

    label {
        font-weight: 600;
        color: var(--kide-ink-header);
        font-size: 0.9rem;
    }

    select {
        padding: var(--kide-space-3);
        border: 1px solid var(--kide-border-strong);
        border-radius: var(--kide-radius-sm);
        font-family: inherit;
        font-size: 1rem;
        background: var(--kide-surface);
    }

    /* Creators Section */
    .creators-section {
        margin: var(--kide-space-6) 0;
        padding: var(--kide-space-4);
        border: 1px solid var(--kide-border-weak);
        border-radius: var(--kide-radius-md);
        background: var(--kide-subtle);
    }

    h3 {
        margin-top: 0;
        margin-bottom: var(--kide-space-4);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .creator-row {
        display: flex;
        gap: var(--kide-space-2);
        margin-bottom: var(--kide-space-2);
    }

    .creator-select {
        flex: 2;
    }

    .creator-role {
        flex: 1;
        padding: var(--kide-space-3);
        border: 1px solid var(--kide-border-strong);
        border-radius: var(--kide-radius-sm);
    }

    .btn-secondary {
        background: transparent;
        border: 1px dashed var(--kide-border-active);
        color: var(--kide-ink-active);
        padding: var(--kide-space-2) var(--kide-space-4);
        cursor: pointer;
        border-radius: var(--kide-radius-sm);
    }

    .btn-secondary:hover {
        background: var(--kide-glass-white);
        border-color: var(--kide-brand-primary);
        color: var(--kide-brand-primary);
    }

    .btn-icon-remove {
        background: var(--kide-danger-bg);
        color: var(--kide-danger);
        border: none;
        width: 40px;
        cursor: pointer;
        border-radius: var(--kide-radius-sm);
        font-size: 1.25rem;
        line-height: 1;
    }

    .btn-icon-remove:hover {
        background: var(--kide-danger);
        color: white;
    }
</style>
